<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>٩٩٩ — كتابة الرقم والفئة على اللوحات (علوية + سفلية)</title>

  <!-- Tajawal for UI; FE-Schrift for digits -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <!-- html2canvas للحفظ كصورة -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <!-- Preload للخط (لدعم FE.TTF/fe.ttf) -->
  <link rel="preload" href="FE.TTF" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="fe.ttf" as="font" type="font/ttf" crossorigin>

  <style>
    /* دعم أكثر من صيغة/اسم للخط + قصره على الأرقام لضمان تطبيقه */
    @font-face {
      font-family:'FE-Schrift';
      src:
        url('FE.woff2') format('woff2'),
        url('FE.woff') format('woff'),
        url('FE.TTF') format('truetype'),
        url('fe.ttf') format('truetype');
      font-display:swap;
      unicode-range: U+0030-0039; /* 0-9 */
    }

    :root{ --stage-w:540px; }

    body{ font-family:'Tajawal',sans-serif; background:#f6f7f8; margin:0; }
    .wrap{ max-width:var(--stage-w); margin:14px auto; padding:16px; background:#fff; border:1px solid #ddd; border-radius:14px; box-shadow:0 4px 18px rgba(0,0,0,.05); }

    .toolbar{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
    label{ font-size:.9rem; color:#374151; }
    input, select{ width:100%; padding:.55rem .7rem; border:1px solid #ccc; border-radius:10px; font-size:1rem; }

    .stage{ position:relative; width:100%; aspect-ratio:9/16; background:#fff; border-radius:12px; border:1px solid #eee; overflow:hidden; }
    .stage img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }

    /* حاويتان: لوحة علوية ولوحة سفلية */
    .plate{ position:absolute; transform:translate(-50%,-50%); }
    .plate.upper{ left:50%; top:22.5%; width:84%; height:10.8%; }
    .plate.lower{ left:50%; top:82%; width:38%; height:6.8%; }

    /* داخل كل لوحة: عنصران مستقلان + قفل المحتوى داخل الصندوق */
    .field{
      position:absolute;
      transform: translate(-50%,-50%) scale(var(--fit, 1));
      transform-origin: center;
      line-height:1;
      display:flex; align-items:center; justify-content:center;
      white-space:nowrap; box-sizing:border-box; overflow:hidden;
      will-change: transform, font-size;
    }

    .cat{ font-weight:700; color:#fff; font-family:'FE-Schrift','Tajawal',sans-serif; direction:ltr; text-align:center; }
    .digits{ font-family:'FE-Schrift','Tajawal'; font-weight:700; color:#000; direction:ltr; text-align:center; }

    /* السعر أسفل الصورة — رقم فقط مع فواصل */
    .price{
      position:absolute; left:67%; bottom:7.2%; transform:translateX(-50%);
      font-family:'Tajawal',sans-serif; font-weight:700; color:#000;
      direction:ltr; text-align:center; letter-spacing:.3px;
      font-size:30px; z-index:5; user-select:none;
    }

    .actions{ display:flex; justify-content:center; gap:10px; margin-top:12px; }
    .actions button{ padding:.7rem 1rem; border:1px solid #111; background:#111; color:#fff; border-radius:10px; font-weight:700; cursor:pointer; }
    .actions button:hover{ opacity:.9; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div>
        <label>الرقم:</label>
        <input id="plateNumber" type="text" value="99909" />
      </div>
      <div>
        <label>الفئة:</label>
        <input id="plateCat" type="text" value="50" />
      </div>
      <div>
        <label>الصورة:</label>
        <select id="carPick">
          <option value="BRABUS.png">BRABUS G-Class</option>
          <option value="defender.png">Defender (أمامي)</option>
          <option value="GTR GREY.png">911 GT3 RS (أمامي)</option>
          <option value="Nissmo.png">Patrol NISMO</option>
          <option value="Octa.png">Defender OCTA</option>
          <option value="RANGE ROVER.png">Range Rover (خلفي)</option>
          <option value="RANTHA.png">Range Rover (زاوية)</option>
          <option value="RR.png">Rolls-Royce</option>
          <option value="G-CLASS W.png">Mercedes G-Class (أبيض)</option>
          <option value="G-CLASS.png">Mercedes G-Class (أسود)</option>
          <option value="GTR GREEN.png">Porsche 911 GT3 RS (أخضر)</option>
          <option value="GTR WHITE.png">Porsche 911 GT3 RS (أبيض)</option>
        </select>
      </div>
      <!-- خانة السعر (رقم فقط) -->
      <div>
        <label>السعر:</label>
        <input id="priceInput" type="text" value="100000" inputmode="numeric" />
      </div>
    </div>

    <div id="stage" class="stage">
      <img id="carImg" src="BRABUS.png" alt="car" />

      <!-- اللوحة العلوية -->
      <div id="plateTop" class="plate upper">
        <div class="field cat" id="catTop">1</div>
        <div class="field digits" id="digitsTop">11111</div>
      </div>

      <!-- اللوحة السفلية -->
      <div id="plateBottom" class="plate lower">
        <div class="field cat" id="catBottom">1</div>
        <div class="field digits" id="digitsBottom">11111</div>
      </div>

      <!-- السعر أسفل الصورة — رقم فقط -->
      <div id="priceTag" class="price">
        <span id="priceText"></span>
      </div>
    </div>

    <div class="actions">
      <button id="saveBtn">حفظ الصورة (PNG)</button>
    </div>
  </div>

  <script>
    const img          = document.getElementById('carImg');
    const digitsTop    = document.getElementById('digitsTop');
    const digitsBottom = document.getElementById('digitsBottom');
    const catTop       = document.getElementById('catTop');
    const catBottom    = document.getElementById('catBottom');

    const numberInput = document.getElementById('plateNumber');
    const catInput    = document.getElementById('plateCat');
    const pick        = document.getElementById('carPick');

    // سعر
    const priceInput  = document.getElementById('priceInput');
    const priceText   = document.getElementById('priceText');

    const saveBtn     = document.getElementById('saveBtn');
    const stage       = document.getElementById('stage');

    // تحويل الأرقام العربية/الفارسية إلى 0-9 لاتينية
    const mapArabic = '٠١٢٣٤٥٦٧٨٩';
    const mapPersian= '۰۱۲۳۴۵۶۷۸۹';
    function normalizeDigits(str){
      return (str||'').split('').map(ch=>{
        const iA = mapArabic.indexOf(ch); if(iA !== -1) return String(iA);
        const iP = mapPersian.indexOf(ch); if(iP !== -1) return String(iP);
        return ch;
      }).join('');
    }

    // فلترة السعر: أرقام فقط + تنسيق فواصل آلاف
    const onlyNumbers = (s)=> normalizeDigits(s).replace(/\D+/g, '');
    function formatWithCommas(numStr){
      if(!numStr) return '';
      return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    /* القياسات لكل سيارة (اللوحة العلوية والسفلية + مواضع الرقم/الفئة لكل واحدة) */
    const presets = {
      'BRABUS.png': {
        top:    { plate:{l:50,t:22.8,w:86,h:10.8}, digits:{x:68,y:97,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:72} },
        bottom: { plate:{l:50,t:82.0,w:38,h:6.5},  digits:{x:63,y:-103,w:70,h:90, fsH:40}, cat:{x:20,y:-103,w:18,h:90, fsH:30} }
      },
      'defender.png': {
        top:    { plate:{l:50,t:22.8,w:86,h:10.8}, digits:{x:68,y:97,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:50,t:79.5,w:40,h:6.6},  digits:{x:64,y:-62,w:70,h:90, fsH:40}, cat:{x:22,y:-62,w:18,h:90, fsH:30} }
      },
      'GTR GREY.png': {
        top:    { plate:{l:50,t:22.8,w:86,h:10.8}, digits:{x:70,y:97,w:70,h:90, fsH:82}, cat:{x:9,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:50,t:82.0,w:38,h:6.5},  digits:{x:65,y:-96,w:70,h:90, fsH:40}, cat:{x:21,y:-96,w:18,h:90, fsH:30} }
      },
      'Nissmo.png': {
        top:    { plate:{l:50,t:22.8,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:50,t:78.5,w:42,h:6.8},  digits:{x:62,y:-58,w:70,h:90, fsH:40}, cat:{x:20,y:-58,w:18,h:90, fsH:30} }
      },
      'Octa.png': {
        top:    { plate:{l:50,t:23.2,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:9,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:63,t:88.0,w:32,h:6.2},  digits:{x:140,y:-140,w:70,h:90, fsH:40}, cat:{x:70,y:-140,w:18,h:90, fsH:30} }
      },
      'RANGE ROVER.png': {
        top:    { plate:{l:50,t:23.0,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:46,t:77.0,w:30,h:6.0},  digits:{x:58,y:-120,w:70,h:90, fsH:40}, cat:{x:17,y:-120,w:18,h:90, fsH:30} }
      },
      'RANTHA.png': {
        top:    { plate:{l:50,t:23.0,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:50,t:82.5,w:36,h:6.5},  digits:{x:58,y:-120,w:70,h:90, fsH:40}, cat:{x:17,y:-120,w:18,h:90, fsH:30} }
      },
      'RR.png': {
        top:    { plate:{l:50,t:23.0,w:86,h:10.8}, digits:{x:68,y:98,w:70,h:90, fsH:82}, cat:{x:9,y:98,w:16,h:90, fsH:75} },
        bottom: { plate:{l:50,t:82.5,w:42,h:6.6},  digits:{x:58,y:-120,w:70,h:90, fsH:40}, cat:{x:17,y:-120,w:18,h:90, fsH:30} }
      },
      'G-CLASS W.png': {
        top:    { plate:{l:50,t:23.0,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:50,t:81.5,w:40,h:6.5},  digits:{x:58,y:-120,w:70,h:90, fsH:40}, cat:{x:17,y:-120,w:18,h:90, fsH:30} }
      },
      'G-CLASS.png': {
        top:    { plate:{l:50,t:23.0,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:50,t:81.5,w:40,h:6.5},  digits:{x:58,y:-120,w:70,h:90, fsH:40}, cat:{x:17,y:-120,w:18,h:90, fsH:30} }
      },
      'GTR GREEN.png': {
        top:    { plate:{l:50,t:23.0,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:42,t:83.5,w:34,h:6.2},  digits:{x:58,y:-120,w:70,h:90, fsH:40}, cat:{x:17,y:-120,w:18,h:90, fsH:30} }
      },
      'GTR WHITE.png': {
        top:    { plate:{l:50,t:23.0,w:86,h:10.8}, digits:{x:68,y:95,w:70,h:90, fsH:82}, cat:{x:8,y:95,w:16,h:90, fsH:75} },
        bottom: { plate:{l:44,t:83.0,w:34,h:6.2},  digits:{x:58,y:-120,w:70,h:90, fsH:40}, cat:{x:17,y:-120,w:18,h:90, fsH:30} }
      }
    };

    function applyPreset(name){
      const p = presets[name]; if(!p) return;
      setPlateBox(document.getElementById('plateTop'),    p.top.plate);
      setPlateBox(document.getElementById('plateBottom'), p.bottom.plate);

      setInnerBox(document.getElementById('digitsTop'),   p.top.digits);
      setInnerBox(document.getElementById('catTop'),      p.top.cat);
      setInnerBox(document.getElementById('digitsBottom'),p.bottom.digits);
      setInnerBox(document.getElementById('catBottom'),   p.bottom.cat);

      // ضمان عدم الخروج
      fitText(digitsTop); fitText(digitsBottom); fitText(catTop); fitText(catBottom);
    }

    function setPlateBox(el, box){
      el.style.left   = box.l + '%';
      el.style.top    = box.t + '%';
      el.style.width  = box.w + '%';
      el.style.height = box.h + '%';
    }

    // box داخل اللوحة: x,y,w,h كلها بالنسبة للوحة
    function setInnerBox(el, box){
      el.style.left   = (box.x) + '%';
      el.style.top    = (box.y) + '%';
      el.style.width  = (box.w) + '%';
      el.style.height = (box.h) + '%';
      if(box.fsH){
        const plateRect  = el.parentElement.getBoundingClientRect();
        const targetH    = plateRect.height * (box.h/100);
        const fontPx     = targetH * (box.fsH/100);
        el.style.fontSize = Math.max(10, fontPx) + 'px';
      }
    }

    // تقليص الخط أولاً، ثم (إن لزم) scale
    function fitText(el, maxLoops = 30){
      el.style.removeProperty('--fit');
      const cw = el.clientWidth, ch = el.clientHeight;
      if(!cw || !ch) return;

      let loops = 0;
      while (loops < maxLoops && (el.scrollWidth > el.clientWidth || el.scrollHeight > el.clientHeight)) {
        const cur = parseFloat(getComputedStyle(el).fontSize) || 12;
        const next = Math.max(8, cur * 0.95);
        if (Math.abs(next - cur) < 0.25) break;
        el.style.fontSize = next + 'px';
        loops++;
      }

      const sx = el.clientWidth  / el.scrollWidth;
      const sy = el.clientHeight / el.scrollHeight;
      const s  = Math.min(1, sx, sy);
      el.style.setProperty('--fit', s);
    }

    function reapply(){ applyPreset(pick.value); }

    numberInput.addEventListener('input', () => {
      const v = normalizeDigits(numberInput.value || '\u00A0');
      digitsTop.textContent = v; digitsBottom.textContent = v; reapply();
    });
    catInput.addEventListener('input', () => {
      const v = normalizeDigits(catInput.value || ' ');
      catTop.textContent = v; catBottom.textContent = v; reapply();
    });

    // السعر: أرقام فقط + فواصل آلاف أثناء الكتابة
    function updatePrice(){
      const digits = onlyNumbers(priceInput.value);
      const formatted = formatWithCommas(digits);
      priceInput.value = formatted;      // يُظهر الفواصل في خانة الإدخال
      priceText.textContent = formatted; // ويعرضها أسفل الصورة
    }
    priceInput.addEventListener('input', updatePrice);

    pick.addEventListener('change', (e)=>{
      img.src = e.target.value;
      img.onload = ()=>{ reapply(); };
    });

    // تحديث القياسات عند تغيّر حجم المسرح
    const ro = new ResizeObserver(()=>{ reapply(); });
    ro.observe(stage);
    window.addEventListener('resize', reapply);

    // بعد تحميل الخطوط
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(() => { reapply(); });
    }

    // عند التحميل الأول
    window.addEventListener('load', ()=> {
      applyPreset(pick.value);
      updatePrice(); // تزامُن السعر المبدئي مع الفواصل
    });

    // حفظ الصورة
    saveBtn.addEventListener('click', async ()=>{
      await new Promise(r=>setTimeout(r,50));
      const canvas = await html2canvas(stage, {useCORS:true, backgroundColor:null, scale:2});
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = `plate_${Date.now()}.png`;
      document.body.appendChild(a); a.click(); a.remove();
    });
  </script>
</body>
</html>
